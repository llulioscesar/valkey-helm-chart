# Valkey Helm Chart - Minimal Configuration

# Deployment mode: standalone or sentinel
architecture: standalone

global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: ""

# Cluster domain for service discovery
clusterDomain: cluster.local

# Valkey image configuration
# Using Chainguard images for zero CVE security
#
# Why 'latest' tag?
# - Chainguard free tier only provides 'latest' tag
# - Ensures automatic security updates and zero known CVEs
# - appVersion in Chart.yaml tracks the actual version (auto-updated weekly)
#
# For production with version pinning, override with:
#   image:
#     repository: valkey/valkey  # Official Valkey registry
#     tag: "9.0.0"               # Specific version
image:
  registry: cgr.dev
  repository: chainguard/valkey
  tag: "latest"  # Auto-updated by Chainguard, version tracked in Chart.yaml appVersion
  pullPolicy: IfNotPresent

# Common configuration
nameOverride: ""
fullnameOverride: ""

# Authentication configuration
auth:
  enabled: false
  password: ""
  existingSecret: ""
  existingSecretPasswordKey: "password"
  sentinel: false

# Network Policy
networkPolicy:
  enabled: false
  allowExternal: true
  ingressNSMatchLabels: {}
  ingressNSPodMatchLabels: {}

# RBAC configuration
rbac:
  create: false

# Service Account
serviceAccount:
  create: true
  annotations: {}
  name: ""

# Pod Security Context
# Chainguard images run as user 65532
podSecurityContext:
  fsGroup: 65532
  runAsUser: 65532
  runAsGroup: 65532

# Security Context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  runAsNonRoot: true
  runAsUser: 65532

# Common annotations and labels
commonAnnotations: {}
commonLabels: {}

# Standalone Configuration
standalone:
  replicaCount: 1

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  nodeSelector: {}
  tolerations: []
  affinity: {}

  persistence:
    enabled: true
    storageClass: ""
    accessModes:
      - ReadWriteOnce
    size: 8Gi
    annotations: {}

  service:
    type: ClusterIP
    port: 6379
    targetPort: valkey
    annotations: {}

  configuration: |-
    # Valkey configuration
    bind 0.0.0.0
    port 6379
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300

    # Memory configuration
    maxmemory-policy allkeys-lru

    # Persistence
    save 900 1
    save 300 10
    save 60 10000

    # Logging
    loglevel notice

    # Security
    protected-mode no

# Sentinel Configuration
sentinel:
  enabled: false
  replicaCount: 3
  quorum: 2
  masterSet: mymaster
  downAfterMilliseconds: 30000
  failoverTimeout: 180000
  parallelSyncs: 1

  # Sentinel uses the same Chainguard Valkey image (includes sentinel binary)
  # See main image configuration above for versioning strategy
  image:
    registry: cgr.dev
    repository: chainguard/valkey
    tag: "latest"  # Matches main Valkey image tag
    pullPolicy: IfNotPresent

  serviceAccount:
    create: false
    annotations: {}
    name: ""
    automountServiceAccountToken: true

  podSecurityContext:
    enabled: true
    fsGroup: 65532
    runAsUser: 65532
    runAsGroup: 65532

  containerSecurityContext:
    enabled: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 65532

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  livenessProbe:
    enabled: true
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 5

  readinessProbe:
    enabled: true
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 1
    successThreshold: 1
    failureThreshold: 5

  service:
    type: ClusterIP
    port: 26379
    clusterIP: ""
    nodePort: ""
    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    annotations: {}
    sessionAffinity: None
    sessionAffinityConfig: {}
    internalTrafficPolicy: Cluster
    externalTrafficPolicy: Cluster
    extraPorts: []
    nodePorts:
      sentinel: ""
      sentinelTls: ""

  nodeSelector: {}
  tolerations: []
  affinity: {}
  topologySpreadConstraints: []
  priorityClassName: ""
  terminationGracePeriodSeconds: 30

  podAnnotations: {}
  extraEnvVars: []
  extraEnvVarsCM: ""
  extraEnvVarsSecret: ""
  extraVolumes: []
  extraVolumeMounts: []
  initContainers: []
  sidecars: []

  configuration: |-
    # Valkey Sentinel configuration
    port 26379
    dir /tmp

# Master configuration for sentinel mode
master:
  replicaCount: 1

  serviceAccount:
    create: false
    annotations: {}
    name: ""
    automountServiceAccountToken: true

  podSecurityContext:
    enabled: true
    fsGroup: 65532
    runAsUser: 65532
    runAsGroup: 65532

  containerSecurityContext:
    enabled: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 65532

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  livenessProbe:
    enabled: true
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 5

  readinessProbe:
    enabled: true
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 1
    successThreshold: 1
    failureThreshold: 5

  nodeSelector: {}
  tolerations: []
  affinity: {}
  topologySpreadConstraints: []
  priorityClassName: ""
  terminationGracePeriodSeconds: 30

  persistence:
    enabled: true
    storageClass: ""
    accessModes:
      - ReadWriteOnce
    size: 8Gi
    annotations: {}
    selector: {}

  service:
    type: ClusterIP
    port: 6379
    clusterIP: ""
    nodePort: ""
    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    annotations: {}
    sessionAffinity: None
    sessionAffinityConfig: {}
    internalTrafficPolicy: Cluster
    externalTrafficPolicy: Cluster
    extraPorts: []
    nodePorts:
      valkey: ""
      valkeyTls: ""

  podAnnotations: {}
  extraEnvVars: []
  extraEnvVarsCM: ""
  extraEnvVarsSecret: ""
  extraVolumes: []
  extraVolumeMounts: []
  initContainers: []
  sidecars: []

  podSecurityPolicy:
    enabled: false

  podDisruptionBudget:
    enabled: false
    minAvailable: 1
    maxUnavailable: ""

  configuration: |-
    # Valkey master configuration
    bind 0.0.0.0
    port 6379
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300
    maxmemory-policy allkeys-lru
    save 900 1
    save 300 10
    save 60 10000
    loglevel notice
    protected-mode no

# Replica configuration for sentinel mode
replica:
  replicaCount: 2

  serviceAccount:
    create: false
    annotations: {}
    name: ""
    automountServiceAccountToken: true

  podSecurityContext:
    enabled: true
    fsGroup: 65532
    runAsUser: 65532
    runAsGroup: 65532

  containerSecurityContext:
    enabled: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 65532

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  livenessProbe:
    enabled: true
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 5

  readinessProbe:
    enabled: true
    initialDelaySeconds: 20
    periodSeconds: 5
    timeoutSeconds: 1
    successThreshold: 1
    failureThreshold: 5

  nodeSelector: {}
  tolerations: []
  affinity: {}
  topologySpreadConstraints: []
  priorityClassName: ""
  terminationGracePeriodSeconds: 30

  persistence:
    enabled: true
    storageClass: ""
    accessModes:
      - ReadWriteOnce
    size: 8Gi
    annotations: {}
    selector: {}
    subPath: ""

  service:
    type: ClusterIP
    port: 6379
    clusterIP: ""
    nodePort: ""
    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    annotations: {}
    sessionAffinity: None
    sessionAffinityConfig: {}
    internalTrafficPolicy: Cluster
    externalTrafficPolicy: Cluster
    extraPorts: []
    nodePorts:
      valkey: ""
      valkeyTls: ""

  podAnnotations: {}
  extraEnvVars: []
  extraEnvVarsCM: ""
  extraEnvVarsSecret: ""
  extraVolumes: []
  extraVolumeMounts: []
  initContainers: []
  sidecars: []

  configuration: |-
    # Valkey replica configuration
    bind 0.0.0.0
    port 6379
    tcp-backlog 511
    timeout 0
    tcp-keepalive 300
    maxmemory-policy allkeys-lru
    save ""
    loglevel notice
    protected-mode no

# Metrics configuration
metrics:
  enabled: false
  port: 9121

  # Using Chainguard image for zero CVE security (same as Valkey)
  image:
    registry: cgr.dev
    repository: chainguard/prometheus-redis-exporter
    tag: "latest"
    pullPolicy: IfNotPresent

  containerSecurityContext:
    enabled: true
    allowPrivilegeEscalation: false
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 65532

  resources:
    limits:
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  redisTargetHost: "localhost"

  containerPorts:
    http: 9121

  extraArgs: {}

  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "9121"

  service:
    type: ClusterIP
    port: 9121
    annotations: {}
    nodePort: ""
    loadBalancerIP: ""
    loadBalancerSourceRanges: []
    clusterIP: ""
    sessionAffinity: None
    sessionAffinityConfig: {}
    internalTrafficPolicy: Cluster
    externalTrafficPolicy: Cluster
    extraPorts: []

  serviceMonitor:
    enabled: false
    namespace: ""
    interval: ""
    scrapeTimeout: ""
    honorLabels: false
    metricRelabelings: []
    relabelings: []
    annotations: {}
    jobLabel: ""
    additionalLabels: {}
    podTargetLabels: []
    sampleLimit: false
    targetLimit: false
    additionalEndpoints: []

  podMonitor:
    enabled: false
    namespace: ""
    interval: ""
    scrapeTimeout: ""
    honorLabels: false
    metricRelabelings: []
    relabelings: []
    annotations: {}
    jobLabel: ""
    additionalLabels: {}
    podTargetLabels: []
    sampleLimit: false
    targetLimit: false
    additionalEndpoints: []

  prometheusRule:
    enabled: false
    namespace: ""
    labels: {}
    annotations: {}
    rules: []

# Pre-upgrade hook configuration
# Uses Chainguard kubectl image (zero CVE, distroless)
preUpgradeHook:
  image:
    registry: cgr.dev
    repository: chainguard/kubectl
    tag: "latest"
    pullPolicy: IfNotPresent

  resources:
    limits:
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

# Init containers for volume permissions
volumePermissions:
  enabled: false
  image:
    registry: cgr.dev
    repository: chainguard/wolfi-base
    tag: "latest"
    pullPolicy: IfNotPresent

  containerSecurityContext:
    enabled: true
    capabilities:
      drop:
      - ALL
      add:
      - CHOWN
      - FOWNER
      - DAC_OVERRIDE
    runAsUser: 0

  resources:
    limits:
      memory: 128Mi
    requests:
      cpu: 50m
      memory: 64Mi

# Sysctls configuration
sysctls:
  enabled: false

# Additional configuration options
existingConfigmap: ""

# Extra environment variables
extraEnvVars: []

# Extra volumes
extraVolumes: []

# Extra volume mounts
extraVolumeMounts: []

# TLS Configuration
tls:
  enabled: false
  port: 6380
  existingSecret: ""
  certFilename: "tls.crt"
  certKeyFilename: "tls.key"
  caCertFilename: "ca.crt"
  authClients: true

# Extra resources to deploy
extraDeploy: []

# External service configuration (can be configured via service type)
# Use standalone.service.type: LoadBalancer for external access

# Service Binding configuration
serviceBinding:
  enabled: false

# Headless service configuration
headlessService:
  annotations: {}
  extraPorts: []

# Pod Security Policy
podSecurityPolicy:
  enabled: false

# Diagnostic mode
diagnosticMode:
  enabled: false

