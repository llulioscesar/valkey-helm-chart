name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'LICENSE'

jobs:
  lint:
    name: Lint Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Lint chart
        run: helm lint .

  test:
    name: Test Templates
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      matrix:
        config:
          - name: standalone-default
            args: ""
          - name: standalone-auth
            args: "--set auth.enabled=true --set auth.password=test"
          - name: standalone-persistence
            args: "--set standalone.persistence.enabled=true --set standalone.persistence.size=10Gi"
          - name: standalone-metrics
            args: "--set metrics.enabled=true"
          - name: sentinel-mode
            args: "--set architecture=sentinel --set auth.enabled=true --set auth.password=test"
          - name: sentinel-metrics
            args: "--set architecture=sentinel --set metrics.enabled=true"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Test template - ${{ matrix.config.name }}
        run: |
          helm template test . ${{ matrix.config.args }} > output.yaml
          echo "✅ Template generation passed for ${{ matrix.config.name }}"

      - name: Validate manifests - ${{ matrix.config.name }}
        run: |
          grep -q "kind: StatefulSet" output.yaml || (echo "❌ StatefulSet not found" && exit 1)
          grep -q "kind: Service" output.yaml || (echo "❌ Service not found" && exit 1)
          grep -q "kind: ConfigMap" output.yaml || (echo "❌ ConfigMap not found" && exit 1)
          echo "✅ Manifest validation passed for ${{ matrix.config.name }}"

  package:
    name: Package Chart
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.16.0

      - name: Package chart
        run: |
          helm package .
          ls -la *.tgz
          echo "✅ Chart packaging passed"

  schema-validation:
    name: Validate Values Schema
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate JSON schema
        run: |
          if [ -f values.schema.json ]; then
            python3 -m json.tool values.schema.json > /dev/null
            echo "✅ values.schema.json is valid JSON"
          else
            echo "⚠️ values.schema.json not found"
          fi
